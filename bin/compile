#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>
# $HOME: /app

set -e

BUILD_DIR=${1:-.}
CACHE_DIR=${2:-}
ENV_DIR=${3:-}

HEROKU_DIR=$BUILD_DIR/.heroku
BIN_DIR=$HEROKU_DIR/bin

# To enable the local source build cache path, copy the files and match the build path with the startup path.
cp -rpT $BUILD_DIR $HOME
cd $HOME

# install deno
export DENO_INSTALL=$BUILD_DIR/.heroku
export DENO_DIR=$BUILD_DIR/.heroku/cache
curl -fsSL https://deno.land/x/install/install.sh | sh

# set environment variables
PROFILE_PATH="$BUILD_DIR/.profile.d/deno.sh"
mkdir -p $(dirname $PROFILE_PATH)
echo 'export PATH="$HOME/.heroku/bin:$PATH"' >> $PROFILE_PATH
echo 'export DENO_DIR="$HOME/.heroku/cache"' >> $PROFILE_PATH

set +e
